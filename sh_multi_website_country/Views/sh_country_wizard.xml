<odoo>
    <template id="country_selection_modal" name="Country Selection Modal" inherit_id="website.layout">
        <xpath expr="//body" position="inside">
            <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
            <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

            <t t-set="selected_country_id" t-value="request.session.get('selected_country_id')"/>
            <t t-set="selected_country" t-value="request.env['res.country'].sudo().browse(selected_country_id)"/>

            <div id="country-modal" class="modal" tabindex="-1" role="dialog">
                <div class="modal-dialog" role="document">
                    <div class="modal-content p-4">
                        <div class="modal-header d-flex justify-content-between align-items-center">
                            <h5 class="modal-title" id="createAppointmentModalLabel">Choose a Country</h5>
                            <button type="button" class="close" data-bs-dismiss="modal"
                                aria-label="Close">
                                <span aria-hidden="true">&amp;times;</span>
                            </button>
                        </div>
                        <div class="modal-body">

                            <t t-set="company" t-value="request.env.company"/>
                            <t t-set="allowed_country_ids" t-value="company.sh_country_group_ids.mapped('country_ids')"/>
                            <select id="country-select" class="form-control">
                                <t t-foreach="allowed_country_ids" t-as="country">
                                    <option t-att-value="country.id"
                                            t-att-selected="country.id == request.session.get('selected_country_id')">
                                        <t t-esc="country.name"/>
                                    </option>

                                </t>
                            </select>
                            <br/>
                            <br/>
                            <img id="country-flag"
                                t-attf-src="#{selected_country.image_url}"
                                alt="Flag"
                                t-attf-style="#{selected_country and 'max-height: 40px; display:block;' or 'display:none;'}"/>

                                <t t-if="request.session.get('selected_country_id')">
                                    <t t-set="selected_country" t-value="request.env['res.country'].browse(request.session.get('selected_country_id'))"/>
                                    <p class="text-muted text-center">Your location is set to <strong><t t-esc="selected_country.name"/></strong></p>
                                </t>
                        </div>
                        
                    </div>
                </div>
            </div>

            <script>
                document.addEventListener('DOMContentLoaded', function () {
                    console.log("popup display")
                    const modalInstance = new bootstrap.Modal(document.getElementById('country-modal'), {
                        backdrop: 'static',
                        keyboard: false
                    });
                    modalInstance.show();

                    $('#country-select').on('change', function () {

                        console.log("apply button")
                        const countryId = $('#country-select').val();
                        console.log("Selected country ID:", countryId); // Debug: Log the countryId

                        if (countryId) {
                            $.ajax({
                                url: '/set_country',
                                type: 'POST',
                                
                                data: { country_id: countryId },
                                success: function (response) {
                                    console.log("AJAX response:", response);
                                    if (response.success) {
                                        location.reload(); // Reload page on success
                                    } else {
                                        alert("Error: " + (response.error || "Could not apply country selection."));
                                    }
                                },
                            });
                        } else {
                            alert("Please select a country.");
                        }
                    });
                });
            </script>
        </xpath>
    </template>
</odoo>
